# Evangelos Kontopantelis, David Springate, David Reeves, Darren M Ashcroft, Jose M Valderas, Tim Doran, 2024.

import sys, csv, re

codes = [{"code":"2079","system":"gprdproduct"},{"code":"44903","system":"gprdproduct"},{"code":"33372","system":"gprdproduct"},{"code":"3109","system":"gprdproduct"},{"code":"40400","system":"gprdproduct"},{"code":"11508","system":"gprdproduct"},{"code":"28713","system":"gprdproduct"},{"code":"29306","system":"gprdproduct"},{"code":"17564","system":"gprdproduct"},{"code":"30509","system":"gprdproduct"},{"code":"2073","system":"gprdproduct"},{"code":"25107","system":"gprdproduct"},{"code":"8029","system":"gprdproduct"},{"code":"5221","system":"gprdproduct"},{"code":"16442","system":"gprdproduct"},{"code":"21488","system":"gprdproduct"},{"code":"15126","system":"gprdproduct"},{"code":"3569","system":"gprdproduct"},{"code":"2821","system":"gprdproduct"},{"code":"2822","system":"gprdproduct"},{"code":"10092","system":"gprdproduct"},{"code":"4066","system":"gprdproduct"},{"code":"19907","system":"gprdproduct"},{"code":"7538","system":"gprdproduct"},{"code":"24138","system":"gprdproduct"},{"code":"18763","system":"gprdproduct"},{"code":"34178","system":"gprdproduct"},{"code":"2551","system":"gprdproduct"},{"code":"5893","system":"gprdproduct"},{"code":"6436","system":"gprdproduct"},{"code":"33323","system":"gprdproduct"},{"code":"13825","system":"gprdproduct"},{"code":"1399","system":"gprdproduct"},{"code":"15106","system":"gprdproduct"},{"code":"6021","system":"gprdproduct"},{"code":"3107","system":"gprdproduct"},{"code":"20859","system":"gprdproduct"},{"code":"1157","system":"gprdproduct"},{"code":"9979","system":"gprdproduct"},{"code":"47","system":"gprdproduct"},{"code":"27221","system":"gprdproduct"},{"code":"652","system":"gprdproduct"},{"code":"18567","system":"gprdproduct"},{"code":"2081","system":"gprdproduct"},{"code":"7021","system":"gprdproduct"},{"code":"34946","system":"gprdproduct"},{"code":"35732","system":"gprdproduct"},{"code":"6022","system":"gprdproduct"},{"code":"31634","system":"gprdproduct"},{"code":"6409","system":"gprdproduct"},{"code":"7011","system":"gprdproduct"},{"code":"6305","system":"gprdproduct"},{"code":"25285","system":"gprdproduct"},{"code":"46774","system":"gprdproduct"},{"code":"40404","system":"gprdproduct"},{"code":"34681","system":"gprdproduct"},{"code":"41973","system":"gprdproduct"},{"code":"2824","system":"gprdproduct"},{"code":"5848","system":"gprdproduct"},{"code":"4586","system":"gprdproduct"},{"code":"6560","system":"gprdproduct"},{"code":"7020","system":"gprdproduct"},{"code":"16404","system":"gprdproduct"},{"code":"45135","system":"gprdproduct"},{"code":"11075","system":"gprdproduct"},{"code":"39714","system":"gprdproduct"},{"code":"32783","system":"gprdproduct"},{"code":"3265","system":"gprdproduct"},{"code":"1559","system":"gprdproduct"},{"code":"8885","system":"gprdproduct"},{"code":"10247","system":"gprdproduct"},{"code":"29619","system":"gprdproduct"},{"code":"4456","system":"gprdproduct"},{"code":"3733","system":"gprdproduct"},{"code":"11237","system":"gprdproduct"},{"code":"26318","system":"gprdproduct"},{"code":"5658","system":"gprdproduct"},{"code":"24264","system":"gprdproduct"},{"code":"3225","system":"gprdproduct"},{"code":"25543","system":"gprdproduct"},{"code":"32973","system":"gprdproduct"},{"code":"44187","system":"gprdproduct"},{"code":"6552","system":"gprdproduct"},{"code":"5439","system":"gprdproduct"},{"code":"18737","system":"gprdproduct"},{"code":"28945","system":"gprdproduct"},{"code":"9823","system":"gprdproduct"},{"code":"1576","system":"gprdproduct"},{"code":"19296","system":"gprdproduct"},{"code":"25244","system":"gprdproduct"},{"code":"5449","system":"gprdproduct"},{"code":"43417","system":"gprdproduct"},{"code":"6711","system":"gprdproduct"},{"code":"10650","system":"gprdproduct"},{"code":"13828","system":"gprdproduct"},{"code":"34151","system":"gprdproduct"},{"code":"32931","system":"gprdproduct"},{"code":"6068","system":"gprdproduct"},{"code":"11445","system":"gprdproduct"},{"code":"3350","system":"gprdproduct"}];
REQUIRED_CODES = 1;
with open(sys.argv[1], 'r') as file_in, open('epilepsy-drugs-potential-cases.csv', 'w', newline='') as file_out:
    csv_reader = csv.DictReader(file_in)
    csv_writer = csv.DictWriter(file_out, csv_reader.fieldnames + ["epilepsy-drugs-chewtab---primary-identified"])
    csv_writer.writeheader();
    codes_identified = 0;
    for row in csv_reader:
        newRow = row.copy();
        for cell in row:
            # Iterate cell lists (e.g. codes)
            for item in re.findall(r'\(([^,]*)\,', row[cell]):
                if(item in list(map(lambda code: code['code'], codes))): codes_identified+=1;
                if(codes_identified>=REQUIRED_CODES):
                    newRow["epilepsy-drugs-chewtab---primary-identified"] = "CASE";
                    break;
            if(codes_identified>=REQUIRED_CODES): break;
        if(codes_identified<REQUIRED_CODES):
            newRow["epilepsy-drugs-chewtab---primary-identified"] = "UNK";
        codes_identified=0;
        csv_writer.writerow(newRow)
